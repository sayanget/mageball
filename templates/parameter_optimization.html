<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‚æ•°ä¼˜åŒ–åˆ†æ - çº¢çƒå‘½ä¸­ç‡</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-center mb-8">å‚æ•°ä¼˜åŒ–åˆ†æ - çº¢çƒå‘½ä¸­ç‡</h1>
        
        <!-- å¯¼èˆªé“¾æ¥ -->
        <div class="mb-6 text-center">
            <a href="/" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 mr-4">è¿”å›ä¸»é¡µ</a>
            <a href="/prediction_history" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600">å†å²é¢„æµ‹</a>
        </div>

        <!-- å‚æ•°è®¾ç½®è¡¨å• -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">å‚æ•°è®¾ç½®</h2>
            <form method="post" enctype="multipart/form-data">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                    <!-- å›æµ‹çª—å£å‚æ•° -->
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="text-lg font-medium mb-2 text-blue-800">å›æµ‹çª—å£å‚æ•°</h3>
                        <div class="space-y-2">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">èµ·å§‹å€¼</label>
                                <input type="number" name="window_start" value="100" min="50" max="500" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">ç»“æŸå€¼</label>
                                <input type="number" name="window_end" value="300" min="50" max="500" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">æ­¥é•¿</label>
                                <input type="number" name="window_step" value="50" min="10" max="100" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                            </div>
                        </div>
                    </div>

                    <!-- è¿­ä»£æ­¥é•¿å‚æ•° -->
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h3 class="text-lg font-medium mb-2 text-green-800">è¿­ä»£æ­¥é•¿å‚æ•°</h3>
                        <div class="space-y-2">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">èµ·å§‹å€¼</label>
                                <input type="number" name="step_start" value="10" min="5" max="50" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">ç»“æŸå€¼</label>
                                <input type="number" name="step_end" value="50" min="5" max="100" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">æ­¥é•¿</label>
                                <input type="number" name="step_step" value="10" min="5" max="50" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                            </div>
                        </div>
                    </div>

                    <!-- å…¶ä»–å‚æ•° -->
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <h3 class="text-lg font-medium mb-2 text-purple-800">å…¶ä»–å‚æ•°</h3>
                        <div class="space-y-2">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">æ¨¡æ‹Ÿå½©ç¥¨æ•°é‡</label>
                                <input type="number" name="n_tickets" value="10" min="5" max="20" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">æ•°æ®æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰</label>
                                <input type="file" name="csv_file" accept=".csv" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="text-center">
                    <button type="submit" class="bg-red-500 text-white py-3 px-8 rounded-md hover:bg-red-600 text-lg font-semibold">
                        å¼€å§‹å‚æ•°ä¼˜åŒ–åˆ†æ
                    </button>
                </div>
            </form>
        </div>

        <!-- é”™è¯¯æ¶ˆæ¯ -->
        {% if error %}
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                <p>{{ error }}</p>
            </div>
        {% endif %}

        <!-- ç»“æœå±•ç¤º -->
        {% if result %}
            <!-- æœ€ä½³å‚æ•°å±•ç¤º -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- æœ€é«˜å‘½ä¸­ç‡ç»„åˆ -->
                {% if result.best_params %}
                <div class="bg-gradient-to-r from-green-100 to-blue-100 rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold mb-4 text-center text-green-800">ğŸ† æœ€é«˜çº¢çƒå‘½ä¸­ç‡ç»„åˆ</h2>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-center">
                        <div>
                            <p class="text-2xl font-bold text-green-600">{{ result.best_params.window }}</p>
                            <p class="text-sm text-gray-600">å›æµ‹çª—å£</p>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-blue-600">{{ result.best_params.step }}</p>
                            <p class="text-sm text-gray-600">è¿­ä»£æ­¥é•¿</p>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-purple-600">{{ "%.4f"|format(result.best_params.pb_hit_probability) }}</p>
                            <p class="text-sm text-gray-600">çº¢çƒå‘½ä¸­ç‡</p>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-orange-600">{{ "%.2f"|format(result.best_params.performance_ratio) }}</p>
                            <p class="text-sm text-gray-600">æ€§èƒ½æ¯”ç‡</p>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-red-600">{{ result.best_params.adjusted_window }}</p>
                            <p class="text-sm text-gray-600">å®é™…çª—å£</p>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- æœ€ä½³ç†è®ºè¡¨ç°ç»„åˆ -->
                {% if result.best_theoretical_params %}
                <div class="bg-gradient-to-r from-purple-100 to-pink-100 rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold mb-4 text-center text-purple-800">ğŸ¯ æœ€ä½³ç†è®ºè¡¨ç°ç»„åˆ</h2>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-center">
                        <div>
                            <p class="text-2xl font-bold text-purple-600">{{ result.best_theoretical_params.window }}</p>
                            <p class="text-sm text-gray-600">å›æµ‹çª—å£</p>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-pink-600">{{ result.best_theoretical_params.step }}</p>
                            <p class="text-sm text-gray-600">è¿­ä»£æ­¥é•¿</p>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-indigo-600">{{ "%.4f"|format(result.best_theoretical_params.pb_hit_probability) }}</p>
                            <p class="text-sm text-gray-600">çº¢çƒå‘½ä¸­ç‡</p>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-red-600">{{ "%.2f"|format(result.best_theoretical_params.performance_ratio) }}</p>
                            <p class="text-sm text-gray-600">æ€§èƒ½æ¯”ç‡</p>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-gray-600">{{ result.best_theoretical_params.adjusted_window }}</p>
                            <p class="text-sm text-gray-600">å®é™…çª—å£</p>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- åˆ†ææ‘˜è¦ -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">åˆ†ææ‘˜è¦</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center mb-4">
                    <div>
                        <p class="text-2xl font-bold text-blue-600">{{ result.total_combinations }}</p>
                        <p class="text-sm text-gray-600">æµ‹è¯•ç»„åˆæ•°</p>
                    </div>
                    <div>
                        <p class="text-2xl font-bold text-green-600">{{ result.data_rows }}</p>
                        <p class="text-sm text-gray-600">æ•°æ®è¡Œæ•°</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">å›æµ‹çª—å£èŒƒå›´: {{ result.parameters.window_range }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">æ­¥é•¿èŒƒå›´: {{ result.parameters.step_range }}</p>
                    </div>
                </div>
                
                <!-- è¯´æ˜ -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-medium mb-2">ç»“æœè¯´æ˜</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div class="flex items-start space-x-2">
                            <span class="text-2xl">ğŸ†</span>
                            <div>
                                <p class="font-semibold text-green-700">æœ€é«˜çº¢çƒå‘½ä¸­ç‡ç»„åˆ</p>
                                <p class="text-gray-600">å®é™…å‘½ä¸­çº¢çƒæ¬¡æ•°æœ€å¤šçš„å‚æ•°ç»„åˆï¼Œè¿½æ±‚ç»å¯¹å‘½ä¸­ç‡ã€‚</p>
                            </div>
                        </div>
                        <div class="flex items-start space-x-2">
                            <span class="text-2xl">ğŸ¯</span>
                            <div>
                                <p class="font-semibold text-purple-700">æœ€ä½³ç†è®ºè¡¨ç°ç»„åˆ</p>
                                <p class="text-gray-600">ç›¸å¯¹äºç†è®ºæ¦‚ç‡(1/25=0.04)è¡¨ç°æœ€å¥½çš„å‚æ•°ç»„åˆï¼Œè¿½æ±‚ç›¸å¯¹æ€§èƒ½ã€‚</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è¯¦ç»†ç»“æœè¡¨æ ¼ -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">è¯¦ç»†ç»“æœï¼ˆæŒ‰çº¢çƒå‘½ä¸­ç‡æ’åºï¼‰</h2>
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse border border-gray-300">
                        <thead>
                            <tr class="bg-gray-200">
                                <th class="border border-gray-300 px-2 py-2 text-sm">æ’å</th>
                                <th class="border border-gray-300 px-2 py-2 text-sm">å›æµ‹çª—å£</th>
                                <th class="border border-gray-300 px-2 py-2 text-sm">è¿­ä»£æ­¥é•¿</th>
                                <th class="border border-gray-300 px-2 py-2 text-sm">å®é™…çª—å£</th>
                                <th class="border border-gray-300 px-2 py-2 text-sm">çº¢çƒå‘½ä¸­ç‡</th>
                                <th class="border border-gray-300 px-2 py-2 text-sm">æ€»é¢„æµ‹æ¬¡æ•°</th>
                                <th class="border border-gray-300 px-2 py-2 text-sm">å‘½ä¸­æ¬¡æ•°</th>
                                <th class="border border-gray-300 px-2 py-2 text-sm">æ€§èƒ½æ¯”ç‡</th>
                                <th class="border border-gray-300 px-2 py-2 text-sm">è®¡ç®—æ—¶é—´(ç§’)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in result.optimization_results %}
                                {% set is_best_hit_rate = (result.best_params and row.window == result.best_params.window and row.step == result.best_params.step) %}
                                {% set is_best_theoretical = (result.best_theoretical_params and row.window == result.best_theoretical_params.window and row.step == result.best_theoretical_params.step) %}
                                <tr class="{% if is_best_hit_rate %}bg-green-100 border-2 border-green-500{% elif is_best_theoretical %}bg-purple-100 border-2 border-purple-500{% elif loop.index <= 3 %}bg-yellow-50{% endif %}">
                                    <td class="border border-gray-300 px-2 py-2 text-xs text-center font-bold">
                                        {% if is_best_hit_rate %}ğŸ†
                                        {% elif is_best_theoretical %}ğŸ¯
                                        {% elif loop.index == 1 %}ğŸ¥‡
                                        {% elif loop.index == 2 %}ğŸ¥ˆ
                                        {% elif loop.index == 3 %}ğŸ¥‰
                                        {% else %}{{ loop.index }}{% endif %}
                                    </td>
                                    <td class="border border-gray-300 px-2 py-2 text-xs">{{ row.window }}</td>
                                    <td class="border border-gray-300 px-2 py-2 text-xs">{{ row.step }}</td>
                                    <td class="border border-gray-300 px-2 py-2 text-xs">{{ row.adjusted_window }}</td>
                                    <td class="border border-gray-300 px-2 py-2 text-xs font-bold 
                                        {% if row.pb_hit_probability > 0.05 %}text-green-600
                                        {% elif row.pb_hit_probability > 0.04 %}text-yellow-600
                                        {% else %}text-red-600{% endif %}">
                                        {{ "%.4f"|format(row.pb_hit_probability) }}
                                    </td>
                                    <td class="border border-gray-300 px-2 py-2 text-xs">{{ row.total_predictions }}</td>
                                    <td class="border border-gray-300 px-2 py-2 text-xs">{{ row.total_pb_hits }}</td>
                                    <td class="border border-gray-300 px-2 py-2 text-xs 
                                        {% if row.performance_ratio > 1.2 %}text-green-600
                                        {% elif row.performance_ratio > 0.8 %}text-yellow-600
                                        {% else %}text-red-600{% endif %}">
                                        {{ "%.2f"|format(row.performance_ratio) }}
                                    </td>
                                    <td class="border border-gray-300 px-2 py-2 text-xs">{{ "%.1f"|format(row.compute_time) }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- å¯è§†åŒ–å›¾è¡¨ -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">çº¢çƒå‘½ä¸­ç‡çƒ­åŠ›å›¾</h2>
                <canvas id="heatmapChart" class="w-full h-96"></canvas>
            </div>

            <script>
                // å‡†å¤‡çƒ­åŠ›å›¾æ•°æ®
                const results = {{ result.optimization_results | tojson }};
                const windowValues = [...new Set(results.map(r => r.window))].sort((a, b) => a - b);
                const stepValues = [...new Set(results.map(r => r.step))].sort((a, b) => a - b);
                
                const heatmapData = [];
                stepValues.forEach((step, stepIndex) => {
                    windowValues.forEach((window, windowIndex) => {
                        const result = results.find(r => r.window === window && r.step === step);
                        if (result) {
                            heatmapData.push({
                                x: windowIndex,
                                y: stepIndex,
                                v: result.pb_hit_probability
                            });
                        }
                    });
                });

                // åˆ›å»ºçƒ­åŠ›å›¾
                const ctx = document.getElementById('heatmapChart').getContext('2d');
                new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: 'çº¢çƒå‘½ä¸­ç‡',
                            data: heatmapData,
                            backgroundColor: function(context) {
                                const value = context.parsed.v;
                                const alpha = Math.min(value * 20, 1); // è°ƒæ•´é€æ˜åº¦
                                return `rgba(255, 99, 132, ${alpha})`;
                            },
                            pointRadius: function(context) {
                                const value = context.parsed.v;
                                return Math.max(value * 200, 3); // è°ƒæ•´ç‚¹çš„å¤§å°
                            }
                        }]
                    },
                    options: {
                        scales: {
                            x: {
                                type: 'linear',
                                position: 'bottom',
                                title: { display: true, text: 'å›æµ‹çª—å£' },
                                ticks: {
                                    callback: function(value, index) {
                                        return windowValues[Math.round(value)] || '';
                                    }
                                }
                            },
                            y: {
                                title: { display: true, text: 'è¿­ä»£æ­¥é•¿' },
                                ticks: {
                                    callback: function(value, index) {
                                        return stepValues[Math.round(value)] || '';
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: { display: true, position: 'top' },
                            title: { display: true, text: 'å‚æ•°ç»„åˆçš„çº¢çƒå‘½ä¸­ç‡åˆ†å¸ƒ' },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        const point = context[0];
                                        return `çª—å£: ${windowValues[Math.round(point.parsed.x)]}, æ­¥é•¿: ${stepValues[Math.round(point.parsed.y)]}`;
                                    },
                                    label: function(context) {
                                        return `çº¢çƒå‘½ä¸­ç‡: ${context.parsed.v.toFixed(4)}`;
                                    }
                                }
                            }
                        }
                    }
                });
            </script>
        {% endif %}

    </div>
</body>
</html>